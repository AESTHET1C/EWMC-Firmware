OVERVIEW

The Eli Whitney Mine Controller (EWMC) is an ATmega 328P-powered board that attaches to the rear of the coal mine module within the Eli Whitney Museum's seasonal train display and controls various features of the module. The EWMC Firmware is specific to both the EWMC board and the coal mine module itself. It allows public interaction with the coal mine module in the following ways:

-Offer a single arcade button for the public to press
-Raise or lower the mine shaft elevator when the arcade button is pressed
-Continue raising and lowering the mine shaft elevator while the arcade button is being pressed
-Move the mine cart back and forth while the arcade button is being pressed
-Raise and lower the clamshell loader's bucket when the arcade button is pressed
-Power the electromagnet within the clamshell loader's bucket to pick up objects
-Play multiple short sound effects at random intervals while the arcade button is being pressed

The Firmware also utilizes dual endstop sensors per motor along with an optional startup calibration routine to prevent erroneous motor control. In the event that a malfunction does happen, the Firmware will disable the operation of the affected motor and display an error code on the EWMC board's LED.


SETUP CHECKLIST
1: Connect all sensors, motors, and other elements to the EWMC board (See "WIRING CONNECTIONS")
2: Verify all moving elements are not at the ends of their movement range
3: Apply power to the module
4: Complete the calibration routine (See "CALIBRATION")
5: Verify proper operation


CALIBRATION

Note: When re-powering the board without having unplugged anything, no action by the staff is needed. The calibration routine is skipped when the arcade button is pressed before any motors are powered.

Calibration is needed whenever endstops or motors have been unplugged since the last power-up. It is used to ensure endstops are plugged in correctly and are working, and to establish sanity checks for normal operation. Upon completion of calibration, these values are stored to non-volatile memory. If calibration is skipped, the last known values are used. The calibration routine is started upon the reset of the EWMC board and has two stages:

Stage 1 - Manual Endstop Engagement:
	1: Disengage all endstops.
	2: Manually engage an endstop (A or B) for the elevator. A beep will play upon successful engagement.
	3: Manually engage the opposing endstop for the elevator. Two beeps will play upon successful engagement.
	4: Repeat these steps for the mine cart, then the loader.
	5: Disengage all endstops. A final beep will play upon completion.
	6: Remove hands from all motor paths

	This stage is used to verify endstops are working and plugged into the correct locations. If an endstop does not beep upon engagement, verify the speaker and endstop are working and plugged into the correct locations. Once this stage is completed, calibration continues to stage 2 after a 3-second delay.

Stage 2 - Automated Calibration:
	1: Each motor slowly cycles to each endstop.
	2: Each motor cycles at full speed to each endstop.
	3: Calibration data is stored in non-volatile memory.

	This stage determines the locations of each endstop and the average travel time of each motor in both directions. These values are used during normal operation to determine erroneous endstop operation and motor failures. Note that while safety timers are in place to prevent destructive movements, it is suggested to verify correct operation during this stage. In the event that a motor is making a potentially destructive movement, simply press the arcade button. If this button is pressed, a critical error will be asserted, and all motors halted. Once this stage is completed, the Firmware continues to normal operation.


WIRING CONNECTIONS

The four high-power connections are located on the bottom right of the EWMC board. From left to right, they are:

-Elevator motor
-Mine cart motor
-Loader motor
-Loader electromagnet

The eight low-power connections are located on the bottom left of the EWMC board. From left to right, they are:

-Elevator endstop A
-Elevator endstop B
-Mine cart endstop A
-Mine cart endstop B
-Loader endstop A
-Loader endstop B
-Arcade button
-Speaker

All low-power connections are in non-polarized vertical pairs. Attaching connectors horizontally may cause damage to the EWMC board or the coal mine module. The two endstops for each motor are interchangeable; they will be automatically detected during calibration. If a connector will not plug in fully, check that it is not crooked.


ERROR CODES

During normal operation, the status (red) LED on the EWMC board remains off. However, if the Firmware detects an error, this LED is used to show the detected error. Error codes are implemented by blinking the LED, where the number of consecutive blinks determines the error code. Each blink takes one half second, and the error code is repeated every five seconds. Therefore, an error code of 10 will result in a constantly blinking LED. If multiple errors are detected, they will be shown in ascending order.

Errors 1-6:
	Overview:
		-An endstop failed to engage
		-Error 1 corresponds to endstop #1
		-Error 2 corresponds to endstop #2
		-etc...
	Trigger Conditions:
		-The corresponding motor takes more time than expected to engage the endstop in question
		-The endstop in question was disengaged while the corresponding motor was stationary
	Potential Causes:
		-The endstop in question has failed
		-The motor in question needs to be re-calibrated
		-The endstop was disengaged manually
	Action Taken by Firmware:
		-The corresponding motor is reversed briefly if it was in motion
		-The corresponding motor is disabled until reset
	What To Do:
		-Verify the endstop in question is fully plugged in
		-Verify the endstop in question is positioned correctly
		-Replace or readjust the endstop in question if needed
		-Reset the EWMC board
		-Recalibrate if needed

Errors 7-9:
	Overview:
		-An endstop engaged early
		-Error 7 corresponds to the elevator
		-Error 8 corresponds to the mine cart
		-Error 9 corresponds to the loader
	Trigger Conditions:
		-The corresponding motor takes less time than expected to engage the endstop it was traveling toward
		-An endstop is engaged during calibration stage 1, step 1 or 5.
	Potential Causes:
		-The motor in question needs to be re-calibrated
		-The endstop was engaged manually
		-The endstop has not yet been manually disengaged
	Action Taken by Firmware:
		-The corresponding motor is reversed briefly if it was in motion
		-The corresponding motor is disabled until reset if it was in motion
	What To Do:
		-Reset the EWMC board
		-Recalibrate if needed

Error 10 (Critical error):
	Overview:
		-At least one endstop was engaged erroneously
		-An unrecoverable error was triggered
	Trigger Conditions:
		-Any pair of endstops engages simultaneously while any motor is active
		-Any endstop engages while the corresponding motor is traveling in the opposite direction
		-Any endstop fails to disengage in a reasonable time while the corresponding motor is traveling in the opposite direction
		-Either endstop engages while the corresponding motor is reversing during errors 1-6
		-The arcade button was pressed during stage 2 of calibration
	Potential Causes:
		-The endstops are plugged in incorrectly
		-The endstop was engaged manually
		-The arcade button was pressed during stage 2 of calibration
	Action Taken by Firmware:
		-All motors are disabled until reset
	What To Do:
		-Verify the endstops are plugged into the correct places
		-Reset the EWMC board
		-Recalibrate if needed


REPROGRAMMING SOUND EFFECTS

The EWMC board uses a Nuvoton ISD1740 chip to handle driving the speaker and storing sounds. To reprogram the chip, see the ISD1700 Design Guide. The sampling frequency is selected by a resistor of nominal value 68 kOhms.

The Firmware uses 4 main sound effects, played at random intervals. These effects are stored at locations 0x011-0x027, 0x028-0x03E, 0x03F-0x046, and 0x47-0x04F within the ISD1740. An additional "beep" sound effect, used during calibration, is located in row 0x010.